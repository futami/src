<!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.0 Transitional//EN' 'http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd'>
<html xmlns='http://www.w3.org/1999/xhtml'>
<head>
<title>pWal</title>
<meta name='robots' content='noindex,nofollow' />
<meta name='generator' content='GLOBAL-6.6.4' />
<meta http-equiv='Content-Style-Type' content='text/css' />
<link rel='stylesheet' type='text/css' href='../style.css' />
</head>
<body>
<pre>
<span class='curline'><a href='../S/185.html#L40802'>pWal</a>             40802 libdb/sqlite3.c SQLITE_PRIVATE int sqlite3WalClose(Wal *pWal, int sync_flags, int, u8 *);</span>
<span class='curline'><a href='../S/185.html#L40814'>pWal</a>             40814 libdb/sqlite3.c SQLITE_PRIVATE int sqlite3WalBeginReadTransaction(Wal *pWal, int *);</span>
<span class='curline'><a href='../S/185.html#L40815'>pWal</a>             40815 libdb/sqlite3.c SQLITE_PRIVATE void sqlite3WalEndReadTransaction(Wal *pWal);</span>
<span class='curline'><a href='../S/185.html#L40822'>pWal</a>             40822 libdb/sqlite3.c SQLITE_PRIVATE Pgno sqlite3WalDbsize(Wal *pWal);</span>
<span class='curline'><a href='../S/185.html#L40825'>pWal</a>             40825 libdb/sqlite3.c SQLITE_PRIVATE int sqlite3WalBeginWriteTransaction(Wal *pWal);</span>
<span class='curline'><a href='../S/185.html#L40826'>pWal</a>             40826 libdb/sqlite3.c SQLITE_PRIVATE int sqlite3WalEndWriteTransaction(Wal *pWal);</span>
<span class='curline'><a href='../S/185.html#L40829'>pWal</a>             40829 libdb/sqlite3.c SQLITE_PRIVATE int sqlite3WalUndo(Wal *pWal, int (*xUndo)(void *, Pgno), void *pUndoCtx);</span>
<span class='curline'><a href='../S/185.html#L40833'>pWal</a>             40833 libdb/sqlite3.c SQLITE_PRIVATE void sqlite3WalSavepoint(Wal *pWal, u32 *aWalData);</span>
<span class='curline'><a href='../S/185.html#L40837'>pWal</a>             40837 libdb/sqlite3.c SQLITE_PRIVATE int sqlite3WalSavepointUndo(Wal *pWal, u32 *aWalData);</span>
<span class='curline'><a href='../S/185.html#L40840'>pWal</a>             40840 libdb/sqlite3.c SQLITE_PRIVATE int sqlite3WalFrames(Wal *pWal, int, PgHdr *, Pgno, int, int);</span>
<span class='curline'><a href='../S/185.html#L40844'>pWal</a>             40844 libdb/sqlite3.c   Wal *pWal,                      /* Write-ahead log connection */</span>
<span class='curline'><a href='../S/185.html#L40860'>pWal</a>             40860 libdb/sqlite3.c SQLITE_PRIVATE int sqlite3WalCallback(Wal *pWal);</span>
<span class='curline'><a href='../S/185.html#L40865'>pWal</a>             40865 libdb/sqlite3.c SQLITE_PRIVATE int sqlite3WalExclusiveMode(Wal *pWal, int op);</span>
<span class='curline'><a href='../S/185.html#L40871'>pWal</a>             40871 libdb/sqlite3.c SQLITE_PRIVATE int sqlite3WalHeapMemory(Wal *pWal);</span>
<span class='curline'><a href='../S/185.html#L40877'>pWal</a>             40877 libdb/sqlite3.c SQLITE_PRIVATE int sqlite3WalFramesize(Wal *pWal);</span>
<span class='curline'><a href='../S/185.html#L41562'>pWal</a>             41562 libdb/sqlite3.c   Wal *pWal;                  /* Write-ahead log used by "journal_mode=wal" */</span>
<span class='curline'><a href='../S/185.html#L41678'>pWal</a>             41678 libdb/sqlite3.c   return (pPager-&gt;pWal!=0);</span>
<span class='curline'><a href='../S/185.html#L42618'>pWal</a>             42618 libdb/sqlite3.c     sqlite3WalEndReadTransaction(pPager-&gt;pWal);</span>
<span class='curline'><a href='../S/185.html#L42860'>pWal</a>             42860 libdb/sqlite3.c     rc2 = sqlite3WalEndWriteTransaction(pPager-&gt;pWal);</span>
<span class='curline'><a href='../S/185.html#L42879'>pWal</a>             42879 libdb/sqlite3.c    &amp;&amp; (!pagerUseWal(pPager) || sqlite3WalExclusiveMode(pPager-&gt;pWal, 0))</span>
<span class='curline'><a href='../S/185.html#L43741'>pWal</a>             43741 libdb/sqlite3.c     rc = sqlite3WalReadFrame(pPager-&gt;pWal, iFrame, pgsz, pPg-&gt;pData);</span>
<span class='curline'><a href='../S/185.html#L43830'>pWal</a>             43830 libdb/sqlite3.c       rc = sqlite3WalFindFrame(pPager-&gt;pWal, pPg-&gt;pgno, &amp;iFrame);</span>
<span class='curline'><a href='../S/185.html#L43869'>pWal</a>             43869 libdb/sqlite3.c   rc = sqlite3WalUndo(pPager-&gt;pWal, pagerUndoCallback, (void *)pPager);</span>
<span class='curline'><a href='../S/185.html#L43901'>pWal</a>             43901 libdb/sqlite3.c   assert( pPager-&gt;pWal );</span>
<span class='curline'><a href='../S/185.html#L43932'>pWal</a>             43932 libdb/sqlite3.c   rc = sqlite3WalFrames(pPager-&gt;pWal, </span>
<span class='curline'><a href='../S/185.html#L43972'>pWal</a>             43972 libdb/sqlite3.c   sqlite3WalEndReadTransaction(pPager-&gt;pWal);</span>
<span class='curline'><a href='../S/185.html#L43974'>pWal</a>             43974 libdb/sqlite3.c   rc = sqlite3WalBeginReadTransaction(pPager-&gt;pWal, &amp;changed);</span>
<span class='curline'><a href='../S/185.html#L44004'>pWal</a>             44004 libdb/sqlite3.c   nPage = sqlite3WalDbsize(pPager-&gt;pWal);</span>
<span class='curline'><a href='../S/185.html#L44215'>pWal</a>             44215 libdb/sqlite3.c       rc = sqlite3WalSavepointUndo(pPager-&gt;pWal, pSavepoint-&gt;aWalData);</span>
<span class='curline'><a href='../S/185.html#L44833'>pWal</a>             44833 libdb/sqlite3.c   sqlite3WalClose(pPager-&gt;pWal, pPager-&gt;ckptSyncFlags, pPager-&gt;pageSize, pTmp);</span>
<span class='curline'><a href='../S/185.html#L44834'>pWal</a>             44834 libdb/sqlite3.c   pPager-&gt;pWal = 0;</span>
<span class='curline'><a href='../S/185.html#L46039'>pWal</a>             46039 libdb/sqlite3.c     assert( pPager-&gt;pWal==0 || rc==SQLITE_OK );</span>
<span class='curline'><a href='../S/185.html#L46163'>pWal</a>             46163 libdb/sqlite3.c       rc = sqlite3WalFindFrame(pPager-&gt;pWal, pgno, &amp;iFrame);</span>
<span class='curline'><a href='../S/185.html#L46262'>pWal</a>             46262 libdb/sqlite3.c         rc = sqlite3WalFindFrame(pPager-&gt;pWal, pgno, &amp;iFrame);</span>
<span class='curline'><a href='../S/185.html#L46456'>pWal</a>             46456 libdb/sqlite3.c       if( pPager-&gt;exclusiveMode &amp;&amp; sqlite3WalExclusiveMode(pPager-&gt;pWal, -1) ){</span>
<span class='curline'><a href='../S/185.html#L46461'>pWal</a>             46461 libdb/sqlite3.c         sqlite3WalExclusiveMode(pPager-&gt;pWal, 1);</span>
<span class='curline'><a href='../S/185.html#L46469'>pWal</a>             46469 libdb/sqlite3.c       rc = sqlite3WalBeginWriteTransaction(pPager-&gt;pWal);</span>
<span class='curline'><a href='../S/185.html#L47380'>pWal</a>             47380 libdb/sqlite3.c         sqlite3WalSavepoint(pPager-&gt;pWal, aNew[ii].aWalData);</span>
<span class='curline'><a href='../S/185.html#L47743'>pWal</a>             47743 libdb/sqlite3.c   assert( pPager-&gt;exclusiveMode || 0==sqlite3WalHeapMemory(pPager-&gt;pWal) );</span>
<span class='curline'><a href='../S/185.html#L47744'>pWal</a>             47744 libdb/sqlite3.c   if( eMode&gt;=0 &amp;&amp; !pPager-&gt;tempFile &amp;&amp; !sqlite3WalHeapMemory(pPager-&gt;pWal) ){</span>
<span class='curline'><a href='../S/185.html#L47891'>pWal</a>             47891 libdb/sqlite3.c     sqlite3WalLimit(pPager-&gt;pWal, iLimit);</span>
<span class='curline'><a href='../S/185.html#L47925'>pWal</a>             47925 libdb/sqlite3.c   if( pPager-&gt;pWal ){</span>
<span class='curline'><a href='../S/185.html#L47926'>pWal</a>             47926 libdb/sqlite3.c     rc = sqlite3WalCheckpoint(pPager-&gt;pWal, eMode,</span>
<span class='curline'><a href='../S/185.html#L47936'>pWal</a>             47936 libdb/sqlite3.c   return sqlite3WalCallback(pPager-&gt;pWal);</span>
<span class='curline'><a href='../S/185.html#L47975'>pWal</a>             47975 libdb/sqlite3.c   assert( pPager-&gt;pWal==0 &amp;&amp; pPager-&gt;tempFile==0 );</span>
<span class='curline'><a href='../S/185.html#L47993'>pWal</a>             47993 libdb/sqlite3.c         pPager-&gt;journalSizeLimit, &amp;pPager-&gt;pWal</span>
<span class='curline'><a href='../S/185.html#L48027'>pWal</a>             48027 libdb/sqlite3.c   assert( pbOpen!=0 || (!pPager-&gt;tempFile &amp;&amp; !pPager-&gt;pWal) );</span>
<span class='curline'><a href='../S/185.html#L48029'>pWal</a>             48029 libdb/sqlite3.c   if( !pPager-&gt;tempFile &amp;&amp; !pPager-&gt;pWal ){</span>
<span class='curline'><a href='../S/185.html#L48065'>pWal</a>             48065 libdb/sqlite3.c   if( !pPager-&gt;pWal ){</span>
<span class='curline'><a href='../S/185.html#L48081'>pWal</a>             48081 libdb/sqlite3.c   if( rc==SQLITE_OK &amp;&amp; pPager-&gt;pWal ){</span>
<span class='curline'><a href='../S/185.html#L48084'>pWal</a>             48084 libdb/sqlite3.c       rc = sqlite3WalClose(pPager-&gt;pWal, pPager-&gt;ckptSyncFlags,</span>
<span class='curline'><a href='../S/185.html#L48086'>pWal</a>             48086 libdb/sqlite3.c       pPager-&gt;pWal = 0;</span>
<span class='curline'><a href='../S/185.html#L48105'>pWal</a>             48105 libdb/sqlite3.c   return sqlite3WalFramesize(pPager-&gt;pWal);</span>
<span class='curline'><a href='../S/185.html#L48629'>pWal</a>             48629 libdb/sqlite3.c static int walIndexPage(Wal *pWal, int iPage, volatile u32 **ppPage){</span>
<span class='curline'><a href='../S/185.html#L48633'>pWal</a>             48633 libdb/sqlite3.c   if( pWal-&gt;nWiData&lt;=iPage ){</span>
<span class='curline'><a href='../S/185.html#L48636'>pWal</a>             48636 libdb/sqlite3.c     apNew = (volatile u32 **)sqlite3_realloc((void *)pWal-&gt;apWiData, nByte);</span>
<span class='curline'><a href='../S/185.html#L48641'>pWal</a>             48641 libdb/sqlite3.c     memset((void*)&amp;apNew[pWal-&gt;nWiData], 0,</span>
<span class='curline'><a href='../S/185.html#L48642'>pWal</a>             48642 libdb/sqlite3.c            sizeof(u32*)*(iPage+1-pWal-&gt;nWiData));</span>
<span class='curline'><a href='../S/185.html#L48643'>pWal</a>             48643 libdb/sqlite3.c     pWal-&gt;apWiData = apNew;</span>
<span class='curline'><a href='../S/185.html#L48644'>pWal</a>             48644 libdb/sqlite3.c     pWal-&gt;nWiData = iPage+1;</span>
<span class='curline'><a href='../S/185.html#L48648'>pWal</a>             48648 libdb/sqlite3.c   if( pWal-&gt;apWiData[iPage]==0 ){</span>
<span class='curline'><a href='../S/185.html#L48649'>pWal</a>             48649 libdb/sqlite3.c     if( pWal-&gt;exclusiveMode==WAL_HEAPMEMORY_MODE ){</span>
<span class='curline'><a href='../S/185.html#L48650'>pWal</a>             48650 libdb/sqlite3.c       pWal-&gt;apWiData[iPage] = (u32 volatile *)sqlite3MallocZero(WALINDEX_PGSZ);</span>
<span class='curline'><a href='../S/185.html#L48651'>pWal</a>             48651 libdb/sqlite3.c       if( !pWal-&gt;apWiData[iPage] ) rc = SQLITE_NOMEM;</span>
<span class='curline'><a href='../S/185.html#L48653'>pWal</a>             48653 libdb/sqlite3.c       rc = sqlite3OsShmMap(pWal-&gt;pDbFd, iPage, WALINDEX_PGSZ, </span>
<span class='curline'><a href='../S/185.html#L48654'>pWal</a>             48654 libdb/sqlite3.c           pWal-&gt;writeLock, (void volatile **)&amp;pWal-&gt;apWiData[iPage]</span>
<span class='curline'><a href='../S/185.html#L48657'>pWal</a>             48657 libdb/sqlite3.c         pWal-&gt;readOnly |= WAL_SHM_RDONLY;</span>
<span class='curline'><a href='../S/185.html#L48663'>pWal</a>             48663 libdb/sqlite3.c   *ppPage = pWal-&gt;apWiData[iPage];</span>
<span class='curline'><a href='../S/185.html#L48671'>pWal</a>             48671 libdb/sqlite3.c static volatile WalCkptInfo *walCkptInfo(Wal *pWal){</span>
<span class='curline'><a href='../S/185.html#L48672'>pWal</a>             48672 libdb/sqlite3.c   assert( pWal-&gt;nWiData&gt;0 &amp;&amp; pWal-&gt;apWiData[0] );</span>
<span class='curline'><a href='../S/185.html#L48673'>pWal</a>             48673 libdb/sqlite3.c   return (volatile WalCkptInfo*)&amp;(pWal-&gt;apWiData[0][sizeof(WalIndexHdr)/2]);</span>
<span class='curline'><a href='../S/185.html#L48679'>pWal</a>             48679 libdb/sqlite3.c static volatile WalIndexHdr *walIndexHdr(Wal *pWal){</span>
<span class='curline'><a href='../S/185.html#L48680'>pWal</a>             48680 libdb/sqlite3.c   assert( pWal-&gt;nWiData&gt;0 &amp;&amp; pWal-&gt;apWiData[0] );</span>
<span class='curline'><a href='../S/185.html#L48681'>pWal</a>             48681 libdb/sqlite3.c   return (volatile WalIndexHdr*)pWal-&gt;apWiData[0];</span>
<span class='curline'><a href='../S/185.html#L48743'>pWal</a>             48743 libdb/sqlite3.c static void walShmBarrier(Wal *pWal){</span>
<span class='curline'><a href='../S/185.html#L48744'>pWal</a>             48744 libdb/sqlite3.c   if( pWal-&gt;exclusiveMode!=WAL_HEAPMEMORY_MODE ){</span>
<span class='curline'><a href='../S/185.html#L48745'>pWal</a>             48745 libdb/sqlite3.c     sqlite3OsShmBarrier(pWal-&gt;pDbFd);</span>
<span class='curline'><a href='../S/185.html#L48754'>pWal</a>             48754 libdb/sqlite3.c static void walIndexWriteHdr(Wal *pWal){</span>
<span class='curline'><a href='../S/185.html#L48755'>pWal</a>             48755 libdb/sqlite3.c   volatile WalIndexHdr *aHdr = walIndexHdr(pWal);</span>
<span class='curline'><a href='../S/185.html#L48758'>pWal</a>             48758 libdb/sqlite3.c   assert( pWal-&gt;writeLock );</span>
<span class='curline'><a href='../S/185.html#L48759'>pWal</a>             48759 libdb/sqlite3.c   pWal-&gt;hdr.isInit = 1;</span>
<span class='curline'><a href='../S/185.html#L48760'>pWal</a>             48760 libdb/sqlite3.c   pWal-&gt;hdr.iVersion = WALINDEX_MAX_VERSION;</span>
<span class='curline'><a href='../S/185.html#L48761'>pWal</a>             48761 libdb/sqlite3.c   walChecksumBytes(1, (u8*)&amp;pWal-&gt;hdr, nCksum, 0, pWal-&gt;hdr.aCksum);</span>
<span class='curline'><a href='../S/185.html#L48762'>pWal</a>             48762 libdb/sqlite3.c   memcpy((void *)&amp;aHdr[1], (void *)&amp;pWal-&gt;hdr, sizeof(WalIndexHdr));</span>
<span class='curline'><a href='../S/185.html#L48763'>pWal</a>             48763 libdb/sqlite3.c   walShmBarrier(pWal);</span>
<span class='curline'><a href='../S/185.html#L48764'>pWal</a>             48764 libdb/sqlite3.c   memcpy((void *)&amp;aHdr[0], (void *)&amp;pWal-&gt;hdr, sizeof(WalIndexHdr));</span>
<span class='curline'><a href='../S/185.html#L48781'>pWal</a>             48781 libdb/sqlite3.c   Wal *pWal,                      /* The write-ahead log */</span>
<span class='curline'><a href='../S/185.html#L48788'>pWal</a>             48788 libdb/sqlite3.c   u32 *aCksum = pWal-&gt;hdr.aFrameCksum;</span>
<span class='curline'><a href='../S/185.html#L48792'>pWal</a>             48792 libdb/sqlite3.c   memcpy(&amp;aFrame[8], pWal-&gt;hdr.aSalt, 8);</span>
<span class='curline'><a href='../S/185.html#L48794'>pWal</a>             48794 libdb/sqlite3.c   nativeCksum = (pWal-&gt;hdr.bigEndCksum==SQLITE_BIGENDIAN);</span>
<span class='curline'><a href='../S/185.html#L48796'>pWal</a>             48796 libdb/sqlite3.c   walChecksumBytes(nativeCksum, aData, pWal-&gt;szPage, aCksum, aCksum);</span>
<span class='curline'><a href='../S/185.html#L48808'>pWal</a>             48808 libdb/sqlite3.c   Wal *pWal,                      /* The write-ahead log */</span>
<span class='curline'><a href='../S/185.html#L48815'>pWal</a>             48815 libdb/sqlite3.c   u32 *aCksum = pWal-&gt;hdr.aFrameCksum;</span>
<span class='curline'><a href='../S/185.html#L48822'>pWal</a>             48822 libdb/sqlite3.c   if( memcmp(&amp;pWal-&gt;hdr.aSalt, &amp;aFrame[8], 8)!=0 ){</span>
<span class='curline'><a href='../S/185.html#L48838'>pWal</a>             48838 libdb/sqlite3.c   nativeCksum = (pWal-&gt;hdr.bigEndCksum==SQLITE_BIGENDIAN);</span>
<span class='curline'><a href='../S/185.html#L48840'>pWal</a>             48840 libdb/sqlite3.c   walChecksumBytes(nativeCksum, aData, pWal-&gt;szPage, aCksum, aCksum);</span>
<span class='curline'><a href='../S/185.html#L48886'>pWal</a>             48886 libdb/sqlite3.c static int walLockShared(Wal *pWal, int lockIdx){</span>
<span class='curline'><a href='../S/185.html#L48888'>pWal</a>             48888 libdb/sqlite3.c   if( pWal-&gt;exclusiveMode ) return SQLITE_OK;</span>
<span class='curline'><a href='../S/185.html#L48889'>pWal</a>             48889 libdb/sqlite3.c   rc = sqlite3OsShmLock(pWal-&gt;pDbFd, lockIdx, 1,</span>
<span class='curline'><a href='../S/185.html#L48891'>pWal</a>             48891 libdb/sqlite3.c   WALTRACE(("WAL%p: acquire SHARED-%s %s\n", pWal,</span>
<span class='curline'><a href='../S/185.html#L48893'>pWal</a>             48893 libdb/sqlite3.c   VVA_ONLY( pWal-&gt;lockError = (u8)(rc!=SQLITE_OK &amp;&amp; rc!=SQLITE_BUSY); )</span>
<span class='curline'><a href='../S/185.html#L48896'>pWal</a>             48896 libdb/sqlite3.c static void walUnlockShared(Wal *pWal, int lockIdx){</span>
<span class='curline'><a href='../S/185.html#L48897'>pWal</a>             48897 libdb/sqlite3.c   if( pWal-&gt;exclusiveMode ) return;</span>
<span class='curline'><a href='../S/185.html#L48898'>pWal</a>             48898 libdb/sqlite3.c   (void)sqlite3OsShmLock(pWal-&gt;pDbFd, lockIdx, 1,</span>
<span class='curline'><a href='../S/185.html#L48900'>pWal</a>             48900 libdb/sqlite3.c   WALTRACE(("WAL%p: release SHARED-%s\n", pWal, walLockName(lockIdx)));</span>
<span class='curline'><a href='../S/185.html#L48902'>pWal</a>             48902 libdb/sqlite3.c static int walLockExclusive(Wal *pWal, int lockIdx, int n){</span>
<span class='curline'><a href='../S/185.html#L48904'>pWal</a>             48904 libdb/sqlite3.c   if( pWal-&gt;exclusiveMode ) return SQLITE_OK;</span>
<span class='curline'><a href='../S/185.html#L48905'>pWal</a>             48905 libdb/sqlite3.c   rc = sqlite3OsShmLock(pWal-&gt;pDbFd, lockIdx, n,</span>
<span class='curline'><a href='../S/185.html#L48907'>pWal</a>             48907 libdb/sqlite3.c   WALTRACE(("WAL%p: acquire EXCLUSIVE-%s cnt=%d %s\n", pWal,</span>
<span class='curline'><a href='../S/185.html#L48909'>pWal</a>             48909 libdb/sqlite3.c   VVA_ONLY( pWal-&gt;lockError = (u8)(rc!=SQLITE_OK &amp;&amp; rc!=SQLITE_BUSY); )</span>
<span class='curline'><a href='../S/185.html#L48912'>pWal</a>             48912 libdb/sqlite3.c static void walUnlockExclusive(Wal *pWal, int lockIdx, int n){</span>
<span class='curline'><a href='../S/185.html#L48913'>pWal</a>             48913 libdb/sqlite3.c   if( pWal-&gt;exclusiveMode ) return;</span>
<span class='curline'><a href='../S/185.html#L48914'>pWal</a>             48914 libdb/sqlite3.c   (void)sqlite3OsShmLock(pWal-&gt;pDbFd, lockIdx, n,</span>
<span class='curline'><a href='../S/185.html#L48916'>pWal</a>             48916 libdb/sqlite3.c   WALTRACE(("WAL%p: release EXCLUSIVE-%s cnt=%d\n", pWal,</span>
<span class='curline'><a href='../S/185.html#L48949'>pWal</a>             48949 libdb/sqlite3.c   Wal *pWal,                      /* WAL handle */</span>
<span class='curline'><a href='../S/185.html#L48958'>pWal</a>             48958 libdb/sqlite3.c   rc = walIndexPage(pWal, iHash, &amp;aPgno);</span>
<span class='curline'><a href='../S/185.html#L49000'>pWal</a>             49000 libdb/sqlite3.c static u32 walFramePgno(Wal *pWal, u32 iFrame){</span>
<span class='curline'><a href='../S/185.html#L49003'>pWal</a>             49003 libdb/sqlite3.c     return pWal-&gt;apWiData[0][WALINDEX_HDR_SIZE/sizeof(u32) + iFrame - 1];</span>
<span class='curline'><a href='../S/185.html#L49005'>pWal</a>             49005 libdb/sqlite3.c   return pWal-&gt;apWiData[iHash][(iFrame-1-HASHTABLE_NPAGE_ONE)%HASHTABLE_NPAGE];</span>
<span class='curline'><a href='../S/185.html#L49020'>pWal</a>             49020 libdb/sqlite3.c static void walCleanupHash(Wal *pWal){</span>
<span class='curline'><a href='../S/185.html#L49028'>pWal</a>             49028 libdb/sqlite3.c   assert( pWal-&gt;writeLock );</span>
<span class='curline'><a href='../S/185.html#L49029'>pWal</a>             49029 libdb/sqlite3.c   testcase( pWal-&gt;hdr.mxFrame==HASHTABLE_NPAGE_ONE-1 );</span>
<span class='curline'><a href='../S/185.html#L49030'>pWal</a>             49030 libdb/sqlite3.c   testcase( pWal-&gt;hdr.mxFrame==HASHTABLE_NPAGE_ONE );</span>
<span class='curline'><a href='../S/185.html#L49031'>pWal</a>             49031 libdb/sqlite3.c   testcase( pWal-&gt;hdr.mxFrame==HASHTABLE_NPAGE_ONE+1 );</span>
<span class='curline'><a href='../S/185.html#L49033'>pWal</a>             49033 libdb/sqlite3.c   if( pWal-&gt;hdr.mxFrame==0 ) return;</span>
<span class='curline'><a href='../S/185.html#L49039'>pWal</a>             49039 libdb/sqlite3.c   assert( pWal-&gt;nWiData&gt;walFramePage(pWal-&gt;hdr.mxFrame) );</span>
<span class='curline'><a href='../S/185.html#L49040'>pWal</a>             49040 libdb/sqlite3.c   assert( pWal-&gt;apWiData[walFramePage(pWal-&gt;hdr.mxFrame)] );</span>
<span class='curline'><a href='../S/185.html#L49041'>pWal</a>             49041 libdb/sqlite3.c   walHashGet(pWal, walFramePage(pWal-&gt;hdr.mxFrame), &amp;aHash, &amp;aPgno, &amp;iZero);</span>
<span class='curline'><a href='../S/185.html#L49046'>pWal</a>             49046 libdb/sqlite3.c   iLimit = pWal-&gt;hdr.mxFrame - iZero;</span>
<span class='curline'><a href='../S/185.html#L49082'>pWal</a>             49082 libdb/sqlite3.c static int walIndexAppend(Wal *pWal, u32 iFrame, u32 iPage){</span>
<span class='curline'><a href='../S/185.html#L49088'>pWal</a>             49088 libdb/sqlite3.c   rc = walHashGet(pWal, walFramePage(iFrame), &amp;aHash, &amp;aPgno, &amp;iZero);</span>
<span class='curline'><a href='../S/185.html#L49116'>pWal</a>             49116 libdb/sqlite3.c       walCleanupHash(pWal);</span>
<span class='curline'><a href='../S/185.html#L49171'>pWal</a>             49171 libdb/sqlite3.c static int walIndexRecover(Wal *pWal){</span>
<span class='curline'><a href='../S/185.html#L49184'>pWal</a>             49184 libdb/sqlite3.c   assert( pWal-&gt;ckptLock==1 || pWal-&gt;ckptLock==0 );</span>
<span class='curline'><a href='../S/185.html#L49187'>pWal</a>             49187 libdb/sqlite3.c   assert( pWal-&gt;writeLock );</span>
<span class='curline'><a href='../S/185.html#L49188'>pWal</a>             49188 libdb/sqlite3.c   iLock = WAL_ALL_BUT_WRITE + pWal-&gt;ckptLock;</span>
<span class='curline'><a href='../S/185.html#L49190'>pWal</a>             49190 libdb/sqlite3.c   rc = walLockExclusive(pWal, iLock, nLock);</span>
<span class='curline'><a href='../S/185.html#L49194'>pWal</a>             49194 libdb/sqlite3.c   WALTRACE(("WAL%p: recovery begin...\n", pWal));</span>
<span class='curline'><a href='../S/185.html#L49196'>pWal</a>             49196 libdb/sqlite3.c   memset(&amp;pWal-&gt;hdr, 0, sizeof(WalIndexHdr));</span>
<span class='curline'><a href='../S/185.html#L49198'>pWal</a>             49198 libdb/sqlite3.c   rc = sqlite3OsFileSize(pWal-&gt;pWalFd, &amp;nSize);</span>
<span class='curline'><a href='../S/185.html#L49216'>pWal</a>             49216 libdb/sqlite3.c     rc = sqlite3OsRead(pWal-&gt;pWalFd, aBuf, WAL_HDRSIZE, 0);</span>
<span class='curline'><a href='../S/185.html#L49235'>pWal</a>             49235 libdb/sqlite3.c     pWal-&gt;hdr.bigEndCksum = (u8)(magic&amp;0x00000001);</span>
<span class='curline'><a href='../S/185.html#L49236'>pWal</a>             49236 libdb/sqlite3.c     pWal-&gt;szPage = szPage;</span>
<span class='curline'><a href='../S/185.html#L49237'>pWal</a>             49237 libdb/sqlite3.c     pWal-&gt;nCkpt = sqlite3Get4byte(&amp;aBuf[12]);</span>
<span class='curline'><a href='../S/185.html#L49238'>pWal</a>             49238 libdb/sqlite3.c     memcpy(&amp;pWal-&gt;hdr.aSalt, &amp;aBuf[16], 8);</span>
<span class='curline'><a href='../S/185.html#L49241'>pWal</a>             49241 libdb/sqlite3.c     walChecksumBytes(pWal-&gt;hdr.bigEndCksum==SQLITE_BIGENDIAN, </span>
<span class='curline'><a href='../S/185.html#L49242'>pWal</a>             49242 libdb/sqlite3.c         aBuf, WAL_HDRSIZE-2*4, 0, pWal-&gt;hdr.aFrameCksum</span>
<span class='curline'><a href='../S/185.html#L49244'>pWal</a>             49244 libdb/sqlite3.c     if( pWal-&gt;hdr.aFrameCksum[0]!=sqlite3Get4byte(&amp;aBuf[24])</span>
<span class='curline'><a href='../S/185.html#L49245'>pWal</a>             49245 libdb/sqlite3.c      || pWal-&gt;hdr.aFrameCksum[1]!=sqlite3Get4byte(&amp;aBuf[28])</span>
<span class='curline'><a href='../S/185.html#L49275'>pWal</a>             49275 libdb/sqlite3.c       rc = sqlite3OsRead(pWal-&gt;pWalFd, aFrame, szFrame, iOffset);</span>
<span class='curline'><a href='../S/185.html#L49277'>pWal</a>             49277 libdb/sqlite3.c       isValid = walDecodeFrame(pWal, &amp;pgno, &amp;nTruncate, aData, aFrame);</span>
<span class='curline'><a href='../S/185.html#L49279'>pWal</a>             49279 libdb/sqlite3.c       rc = walIndexAppend(pWal, iFrame, pgno);</span>
<span class='curline'><a href='../S/185.html#L49284'>pWal</a>             49284 libdb/sqlite3.c         pWal-&gt;hdr.mxFrame = iFrame;</span>
<span class='curline'><a href='../S/185.html#L49285'>pWal</a>             49285 libdb/sqlite3.c         pWal-&gt;hdr.nPage = nTruncate;</span>
<span class='curline'><a href='../S/185.html#L49286'>pWal</a>             49286 libdb/sqlite3.c         pWal-&gt;hdr.szPage = (u16)((szPage&amp;0xff00) | (szPage&gt;&gt;16));</span>
<span class='curline'><a href='../S/185.html#L49289'>pWal</a>             49289 libdb/sqlite3.c         aFrameCksum[0] = pWal-&gt;hdr.aFrameCksum[0];</span>
<span class='curline'><a href='../S/185.html#L49290'>pWal</a>             49290 libdb/sqlite3.c         aFrameCksum[1] = pWal-&gt;hdr.aFrameCksum[1];</span>
<span class='curline'><a href='../S/185.html#L49301'>pWal</a>             49301 libdb/sqlite3.c     pWal-&gt;hdr.aFrameCksum[0] = aFrameCksum[0];</span>
<span class='curline'><a href='../S/185.html#L49302'>pWal</a>             49302 libdb/sqlite3.c     pWal-&gt;hdr.aFrameCksum[1] = aFrameCksum[1];</span>
<span class='curline'><a href='../S/185.html#L49303'>pWal</a>             49303 libdb/sqlite3.c     walIndexWriteHdr(pWal);</span>
<span class='curline'><a href='../S/185.html#L49309'>pWal</a>             49309 libdb/sqlite3.c     pInfo = walCkptInfo(pWal);</span>
<span class='curline'><a href='../S/185.html#L49313'>pWal</a>             49313 libdb/sqlite3.c     if( pWal-&gt;hdr.mxFrame ) pInfo-&gt;aReadMark[1] = pWal-&gt;hdr.mxFrame;</span>
<span class='curline'><a href='../S/185.html#L49320'>pWal</a>             49320 libdb/sqlite3.c     if( pWal-&gt;hdr.nPage ){</span>
<span class='curline'><a href='../S/185.html#L49323'>pWal</a>             49323 libdb/sqlite3.c           pWal-&gt;hdr.mxFrame, pWal-&gt;zWalName</span>
<span class='curline'><a href='../S/185.html#L49329'>pWal</a>             49329 libdb/sqlite3.c   WALTRACE(("WAL%p: recovery %s\n", pWal, rc ? "failed" : "ok"));</span>
<span class='curline'><a href='../S/185.html#L49330'>pWal</a>             49330 libdb/sqlite3.c   walUnlockExclusive(pWal, iLock, nLock);</span>
<span class='curline'><a href='../S/185.html#L49337'>pWal</a>             49337 libdb/sqlite3.c static void walIndexClose(Wal *pWal, int isDelete){</span>
<span class='curline'><a href='../S/185.html#L49338'>pWal</a>             49338 libdb/sqlite3.c   if( pWal-&gt;exclusiveMode==WAL_HEAPMEMORY_MODE ){</span>
<span class='curline'><a href='../S/185.html#L49340'>pWal</a>             49340 libdb/sqlite3.c     for(i=0; i&lt;pWal-&gt;nWiData; i++){</span>
<span class='curline'><a href='../S/185.html#L49341'>pWal</a>             49341 libdb/sqlite3.c       sqlite3_free((void *)pWal-&gt;apWiData[i]);</span>
<span class='curline'><a href='../S/185.html#L49342'>pWal</a>             49342 libdb/sqlite3.c       pWal-&gt;apWiData[i] = 0;</span>
<span class='curline'><a href='../S/185.html#L49345'>pWal</a>             49345 libdb/sqlite3.c     sqlite3OsShmUnmap(pWal-&gt;pDbFd, isDelete);</span>
<span class='curline'><a href='../S/185.html#L49434'>pWal</a>             49434 libdb/sqlite3.c SQLITE_PRIVATE void sqlite3WalLimit(Wal *pWal, i64 iLimit){</span>
<span class='curline'><a href='../S/185.html#L49435'>pWal</a>             49435 libdb/sqlite3.c   if( pWal ) pWal-&gt;mxWalSize = iLimit;</span>
<span class='curline'><a href='../S/185.html#L49633'>pWal</a>             49633 libdb/sqlite3.c static int walIteratorInit(Wal *pWal, WalIterator **pp){</span>
<span class='curline'><a href='../S/185.html#L49645'>pWal</a>             49645 libdb/sqlite3.c   assert( pWal-&gt;ckptLock &amp;&amp; pWal-&gt;hdr.mxFrame&gt;0 );</span>
<span class='curline'><a href='../S/185.html#L49646'>pWal</a>             49646 libdb/sqlite3.c   iLast = pWal-&gt;hdr.mxFrame;</span>
<span class='curline'><a href='../S/185.html#L49675'>pWal</a>             49675 libdb/sqlite3.c     rc = walHashGet(pWal, i, &amp;aHash, &amp;aPgno, &amp;iZero);</span>
<span class='curline'><a href='../S/185.html#L49716'>pWal</a>             49716 libdb/sqlite3.c   Wal *pWal,                      /* WAL connection */</span>
<span class='curline'><a href='../S/185.html#L49724'>pWal</a>             49724 libdb/sqlite3.c     rc = walLockExclusive(pWal, lockIdx, n);</span>
<span class='curline'><a href='../S/185.html#L49733'>pWal</a>             49733 libdb/sqlite3.c static int walPagesize(Wal *pWal){</span>
<span class='curline'><a href='../S/185.html#L49734'>pWal</a>             49734 libdb/sqlite3.c   return (pWal-&gt;hdr.szPage&amp;0xfe00) + ((pWal-&gt;hdr.szPage&amp;0x0001)&lt;&lt;16);</span>
<span class='curline'><a href='../S/185.html#L49769'>pWal</a>             49769 libdb/sqlite3.c   Wal *pWal,                      /* Wal connection */</span>
<span class='curline'><a href='../S/185.html#L49787'>pWal</a>             49787 libdb/sqlite3.c   szPage = walPagesize(pWal);</span>
<span class='curline'><a href='../S/185.html#L49790'>pWal</a>             49790 libdb/sqlite3.c   pInfo = walCkptInfo(pWal);</span>
<span class='curline'><a href='../S/185.html#L49791'>pWal</a>             49791 libdb/sqlite3.c   if( pInfo-&gt;nBackfill&gt;=pWal-&gt;hdr.mxFrame ) return SQLITE_OK;</span>
<span class='curline'><a href='../S/185.html#L49794'>pWal</a>             49794 libdb/sqlite3.c   rc = walIteratorInit(pWal, &amp;pIter);</span>
<span class='curline'><a href='../S/185.html#L49807'>pWal</a>             49807 libdb/sqlite3.c   mxSafeFrame = pWal-&gt;hdr.mxFrame;</span>
<span class='curline'><a href='../S/185.html#L49808'>pWal</a>             49808 libdb/sqlite3.c   mxPage = pWal-&gt;hdr.nPage;</span>
<span class='curline'><a href='../S/185.html#L49812'>pWal</a>             49812 libdb/sqlite3.c       assert( y&lt;=pWal-&gt;hdr.mxFrame );</span>
<span class='curline'><a href='../S/185.html#L49813'>pWal</a>             49813 libdb/sqlite3.c       rc = walBusyLock(pWal, xBusy, pBusyArg, WAL_READ_LOCK(i), 1);</span>
<span class='curline'><a href='../S/185.html#L49816'>pWal</a>             49816 libdb/sqlite3.c         walUnlockExclusive(pWal, WAL_READ_LOCK(i), 1);</span>
<span class='curline'><a href='../S/185.html#L49827'>pWal</a>             49827 libdb/sqlite3.c    &amp;&amp; (rc = walBusyLock(pWal, xBusy, pBusyArg, WAL_READ_LOCK(0), 1))==SQLITE_OK</span>
<span class='curline'><a href='../S/185.html#L49834'>pWal</a>             49834 libdb/sqlite3.c       rc = sqlite3OsSync(pWal-&gt;pWalFd, sync_flags);</span>
<span class='curline'><a href='../S/185.html#L49842'>pWal</a>             49842 libdb/sqlite3.c       rc = sqlite3OsFileSize(pWal-&gt;pDbFd, &amp;nSize);</span>
<span class='curline'><a href='../S/185.html#L49844'>pWal</a>             49844 libdb/sqlite3.c         sqlite3OsFileControlHint(pWal-&gt;pDbFd, SQLITE_FCNTL_SIZE_HINT, &amp;nReq);</span>
<span class='curline'><a href='../S/185.html#L49852'>pWal</a>             49852 libdb/sqlite3.c       assert( walFramePgno(pWal, iFrame)==iDbpage );</span>
<span class='curline'><a href='../S/185.html#L49856'>pWal</a>             49856 libdb/sqlite3.c       rc = sqlite3OsRead(pWal-&gt;pWalFd, zBuf, szPage, iOffset);</span>
<span class='curline'><a href='../S/185.html#L49860'>pWal</a>             49860 libdb/sqlite3.c       rc = sqlite3OsWrite(pWal-&gt;pDbFd, zBuf, szPage, iOffset);</span>
<span class='curline'><a href='../S/185.html#L49866'>pWal</a>             49866 libdb/sqlite3.c       if( mxSafeFrame==walIndexHdr(pWal)-&gt;mxFrame ){</span>
<span class='curline'><a href='../S/185.html#L49867'>pWal</a>             49867 libdb/sqlite3.c         i64 szDb = pWal-&gt;hdr.nPage*(i64)szPage;</span>
<span class='curline'><a href='../S/185.html#L49869'>pWal</a>             49869 libdb/sqlite3.c         rc = sqlite3OsTruncate(pWal-&gt;pDbFd, szDb);</span>
<span class='curline'><a href='../S/185.html#L49871'>pWal</a>             49871 libdb/sqlite3.c           rc = sqlite3OsSync(pWal-&gt;pDbFd, sync_flags);</span>
<span class='curline'><a href='../S/185.html#L49880'>pWal</a>             49880 libdb/sqlite3.c     walUnlockExclusive(pWal, WAL_READ_LOCK(0), 1);</span>
<span class='curline'><a href='../S/185.html#L49895'>pWal</a>             49895 libdb/sqlite3.c     assert( pWal-&gt;writeLock );</span>
<span class='curline'><a href='../S/185.html#L49896'>pWal</a>             49896 libdb/sqlite3.c     if( pInfo-&gt;nBackfill&lt;pWal-&gt;hdr.mxFrame ){</span>
<span class='curline'><a href='../S/185.html#L49899'>pWal</a>             49899 libdb/sqlite3.c       assert( mxSafeFrame==pWal-&gt;hdr.mxFrame );</span>
<span class='curline'><a href='../S/185.html#L49900'>pWal</a>             49900 libdb/sqlite3.c       rc = walBusyLock(pWal, xBusy, pBusyArg, WAL_READ_LOCK(1), WAL_NREADER-1);</span>
<span class='curline'><a href='../S/185.html#L49902'>pWal</a>             49902 libdb/sqlite3.c         walUnlockExclusive(pWal, WAL_READ_LOCK(1), WAL_NREADER-1);</span>
<span class='curline'><a href='../S/185.html#L49916'>pWal</a>             49916 libdb/sqlite3.c static void walLimitSize(Wal *pWal, i64 nMax){</span>
<span class='curline'><a href='../S/185.html#L49920'>pWal</a>             49920 libdb/sqlite3.c   rx = sqlite3OsFileSize(pWal-&gt;pWalFd, &amp;sz);</span>
<span class='curline'><a href='../S/185.html#L49922'>pWal</a>             49922 libdb/sqlite3.c     rx = sqlite3OsTruncate(pWal-&gt;pWalFd, nMax);</span>
<span class='curline'><a href='../S/185.html#L49926'>pWal</a>             49926 libdb/sqlite3.c     sqlite3_log(rx, "cannot limit WAL size: %s", pWal-&gt;zWalName);</span>
<span class='curline'><a href='../S/185.html#L49934'>pWal</a>             49934 libdb/sqlite3.c   Wal *pWal,                      /* Wal to close */</span>
<span class='curline'><a href='../S/185.html#L49940'>pWal</a>             49940 libdb/sqlite3.c   if( pWal ){</span>
<span class='curline'><a href='../S/185.html#L49951'>pWal</a>             49951 libdb/sqlite3.c     rc = sqlite3OsLock(pWal-&gt;pDbFd, SQLITE_LOCK_EXCLUSIVE);</span>
<span class='curline'><a href='../S/185.html#L49953'>pWal</a>             49953 libdb/sqlite3.c       if( pWal-&gt;exclusiveMode==WAL_NORMAL_MODE ){</span>
<span class='curline'><a href='../S/185.html#L49954'>pWal</a>             49954 libdb/sqlite3.c         pWal-&gt;exclusiveMode = WAL_EXCLUSIVE_MODE;</span>
<span class='curline'><a href='../S/185.html#L49957'>pWal</a>             49957 libdb/sqlite3.c           pWal, SQLITE_CHECKPOINT_PASSIVE, 0, 0, sync_flags, nBuf, zBuf, 0, 0</span>
<span class='curline'><a href='../S/185.html#L49962'>pWal</a>             49962 libdb/sqlite3.c             pWal-&gt;pDbFd, SQLITE_FCNTL_PERSIST_WAL, &amp;bPersist</span>
<span class='curline'><a href='../S/185.html#L49969'>pWal</a>             49969 libdb/sqlite3.c         }else if( pWal-&gt;mxWalSize&gt;=0 ){</span>
<span class='curline'><a href='../S/185.html#L49976'>pWal</a>             49976 libdb/sqlite3.c           walLimitSize(pWal, 0);</span>
<span class='curline'><a href='../S/185.html#L49981'>pWal</a>             49981 libdb/sqlite3.c     walIndexClose(pWal, isDelete);</span>
<span class='curline'><a href='../S/185.html#L49982'>pWal</a>             49982 libdb/sqlite3.c     sqlite3OsClose(pWal-&gt;pWalFd);</span>
<span class='curline'><a href='../S/185.html#L49985'>pWal</a>             49985 libdb/sqlite3.c       sqlite3OsDelete(pWal-&gt;pVfs, pWal-&gt;zWalName, 0);</span>
<span class='curline'><a href='../S/185.html#L49988'>pWal</a>             49988 libdb/sqlite3.c     WALTRACE(("WAL%p: closed\n", pWal));</span>
<span class='curline'><a href='../S/185.html#L49989'>pWal</a>             49989 libdb/sqlite3.c     sqlite3_free((void *)pWal-&gt;apWiData);</span>
<span class='curline'><a href='../S/185.html#L49990'>pWal</a>             49990 libdb/sqlite3.c     sqlite3_free(pWal);</span>
<span class='curline'><a href='../S/185.html#L50012'>pWal</a>             50012 libdb/sqlite3.c static int walIndexTryHdr(Wal *pWal, int *pChanged){</span>
<span class='curline'><a href='../S/185.html#L50018'>pWal</a>             50018 libdb/sqlite3.c   assert( pWal-&gt;nWiData&gt;0 &amp;&amp; pWal-&gt;apWiData[0] );</span>
<span class='curline'><a href='../S/185.html#L50030'>pWal</a>             50030 libdb/sqlite3.c   aHdr = walIndexHdr(pWal);</span>
<span class='curline'><a href='../S/185.html#L50032'>pWal</a>             50032 libdb/sqlite3.c   walShmBarrier(pWal);</span>
<span class='curline'><a href='../S/185.html#L50046'>pWal</a>             50046 libdb/sqlite3.c   if( memcmp(&amp;pWal-&gt;hdr, &amp;h1, sizeof(WalIndexHdr)) ){</span>
<span class='curline'><a href='../S/185.html#L50048'>pWal</a>             50048 libdb/sqlite3.c     memcpy(&amp;pWal-&gt;hdr, &amp;h1, sizeof(WalIndexHdr));</span>
<span class='curline'><a href='../S/185.html#L50049'>pWal</a>             50049 libdb/sqlite3.c     pWal-&gt;szPage = (pWal-&gt;hdr.szPage&amp;0xfe00) + ((pWal-&gt;hdr.szPage&amp;0x0001)&lt;&lt;16);</span>
<span class='curline'><a href='../S/185.html#L50050'>pWal</a>             50050 libdb/sqlite3.c     testcase( pWal-&gt;szPage&lt;=32768 );</span>
<span class='curline'><a href='../S/185.html#L50051'>pWal</a>             50051 libdb/sqlite3.c     testcase( pWal-&gt;szPage&gt;=65536 );</span>
<span class='curline'><a href='../S/185.html#L50070'>pWal</a>             50070 libdb/sqlite3.c static int walIndexReadHdr(Wal *pWal, int *pChanged){</span>
<span class='curline'><a href='../S/185.html#L50079'>pWal</a>             50079 libdb/sqlite3.c   rc = walIndexPage(pWal, 0, &amp;page0);</span>
<span class='curline'><a href='../S/185.html#L50083'>pWal</a>             50083 libdb/sqlite3.c   assert( page0 || pWal-&gt;writeLock==0 );</span>
<span class='curline'><a href='../S/185.html#L50090'>pWal</a>             50090 libdb/sqlite3.c   badHdr = (page0 ? walIndexTryHdr(pWal, pChanged) : 1);</span>
<span class='curline'><a href='../S/185.html#L50095'>pWal</a>             50095 libdb/sqlite3.c   assert( badHdr==0 || pWal-&gt;writeLock==0 );</span>
<span class='curline'><a href='../S/185.html#L50097'>pWal</a>             50097 libdb/sqlite3.c     if( pWal-&gt;readOnly &amp; WAL_SHM_RDONLY ){</span>
<span class='curline'><a href='../S/185.html#L50098'>pWal</a>             50098 libdb/sqlite3.c       if( SQLITE_OK==(rc = walLockShared(pWal, WAL_WRITE_LOCK)) ){</span>
<span class='curline'><a href='../S/185.html#L50099'>pWal</a>             50099 libdb/sqlite3.c         walUnlockShared(pWal, WAL_WRITE_LOCK);</span>
<span class='curline'><a href='../S/185.html#L50102'>pWal</a>             50102 libdb/sqlite3.c     }else if( SQLITE_OK==(rc = walLockExclusive(pWal, WAL_WRITE_LOCK, 1)) ){</span>
<span class='curline'><a href='../S/185.html#L50103'>pWal</a>             50103 libdb/sqlite3.c       pWal-&gt;writeLock = 1;</span>
<span class='curline'><a href='../S/185.html#L50104'>pWal</a>             50104 libdb/sqlite3.c       if( SQLITE_OK==(rc = walIndexPage(pWal, 0, &amp;page0)) ){</span>
<span class='curline'><a href='../S/185.html#L50105'>pWal</a>             50105 libdb/sqlite3.c         badHdr = walIndexTryHdr(pWal, pChanged);</span>
<span class='curline'><a href='../S/185.html#L50111'>pWal</a>             50111 libdb/sqlite3.c           rc = walIndexRecover(pWal);</span>
<span class='curline'><a href='../S/185.html#L50115'>pWal</a>             50115 libdb/sqlite3.c       pWal-&gt;writeLock = 0;</span>
<span class='curline'><a href='../S/185.html#L50116'>pWal</a>             50116 libdb/sqlite3.c       walUnlockExclusive(pWal, WAL_WRITE_LOCK, 1);</span>
<span class='curline'><a href='../S/185.html#L50124'>pWal</a>             50124 libdb/sqlite3.c   if( badHdr==0 &amp;&amp; pWal-&gt;hdr.iVersion!=WALINDEX_MAX_VERSION ){</span>
<span class='curline'><a href='../S/185.html#L50187'>pWal</a>             50187 libdb/sqlite3.c static int walTryBeginRead(Wal *pWal, int *pChanged, int useWal, int cnt){</span>
<span class='curline'><a href='../S/185.html#L50194'>pWal</a>             50194 libdb/sqlite3.c   assert( pWal-&gt;readLock&lt;0 );     /* Not currently locked */</span>
<span class='curline'><a href='../S/185.html#L50216'>pWal</a>             50216 libdb/sqlite3.c       VVA_ONLY( pWal-&gt;lockError = 1; )</span>
<span class='curline'><a href='../S/185.html#L50220'>pWal</a>             50220 libdb/sqlite3.c     sqlite3OsSleep(pWal-&gt;pVfs, nDelay);</span>
<span class='curline'><a href='../S/185.html#L50224'>pWal</a>             50224 libdb/sqlite3.c     rc = walIndexReadHdr(pWal, pChanged);</span>
<span class='curline'><a href='../S/185.html#L50234'>pWal</a>             50234 libdb/sqlite3.c       if( pWal-&gt;apWiData[0]==0 ){</span>
<span class='curline'><a href='../S/185.html#L50243'>pWal</a>             50243 libdb/sqlite3.c       }else if( SQLITE_OK==(rc = walLockShared(pWal, WAL_RECOVER_LOCK)) ){</span>
<span class='curline'><a href='../S/185.html#L50244'>pWal</a>             50244 libdb/sqlite3.c         walUnlockShared(pWal, WAL_RECOVER_LOCK);</span>
<span class='curline'><a href='../S/185.html#L50255'>pWal</a>             50255 libdb/sqlite3.c   pInfo = walCkptInfo(pWal);</span>
<span class='curline'><a href='../S/185.html#L50256'>pWal</a>             50256 libdb/sqlite3.c   if( !useWal &amp;&amp; pInfo-&gt;nBackfill==pWal-&gt;hdr.mxFrame ){</span>
<span class='curline'><a href='../S/185.html#L50260'>pWal</a>             50260 libdb/sqlite3.c     rc = walLockShared(pWal, WAL_READ_LOCK(0));</span>
<span class='curline'><a href='../S/185.html#L50261'>pWal</a>             50261 libdb/sqlite3.c     walShmBarrier(pWal);</span>
<span class='curline'><a href='../S/185.html#L50263'>pWal</a>             50263 libdb/sqlite3.c       if( memcmp((void *)walIndexHdr(pWal), &amp;pWal-&gt;hdr, sizeof(WalIndexHdr)) ){</span>
<span class='curline'><a href='../S/185.html#L50277'>pWal</a>             50277 libdb/sqlite3.c         walUnlockShared(pWal, WAL_READ_LOCK(0));</span>
<span class='curline'><a href='../S/185.html#L50280'>pWal</a>             50280 libdb/sqlite3.c       pWal-&gt;readLock = 0;</span>
<span class='curline'><a href='../S/185.html#L50296'>pWal</a>             50296 libdb/sqlite3.c     if( mxReadMark&lt;=thisMark &amp;&amp; thisMark&lt;=pWal-&gt;hdr.mxFrame ){</span>
<span class='curline'><a href='../S/185.html#L50304'>pWal</a>             50304 libdb/sqlite3.c     if( (pWal-&gt;readOnly &amp; WAL_SHM_RDONLY)==0</span>
<span class='curline'><a href='../S/185.html#L50305'>pWal</a>             50305 libdb/sqlite3.c      &amp;&amp; (mxReadMark&lt;pWal-&gt;hdr.mxFrame || mxI==0)</span>
<span class='curline'><a href='../S/185.html#L50308'>pWal</a>             50308 libdb/sqlite3.c         rc = walLockExclusive(pWal, WAL_READ_LOCK(i), 1);</span>
<span class='curline'><a href='../S/185.html#L50310'>pWal</a>             50310 libdb/sqlite3.c           mxReadMark = pInfo-&gt;aReadMark[i] = pWal-&gt;hdr.mxFrame;</span>
<span class='curline'><a href='../S/185.html#L50312'>pWal</a>             50312 libdb/sqlite3.c           walUnlockExclusive(pWal, WAL_READ_LOCK(i), 1);</span>
<span class='curline'><a href='../S/185.html#L50320'>pWal</a>             50320 libdb/sqlite3.c       assert( rc==SQLITE_BUSY || (pWal-&gt;readOnly &amp; WAL_SHM_RDONLY)!=0 );</span>
<span class='curline'><a href='../S/185.html#L50324'>pWal</a>             50324 libdb/sqlite3.c     rc = walLockShared(pWal, WAL_READ_LOCK(mxI));</span>
<span class='curline'><a href='../S/185.html#L50348'>pWal</a>             50348 libdb/sqlite3.c     walShmBarrier(pWal);</span>
<span class='curline'><a href='../S/185.html#L50350'>pWal</a>             50350 libdb/sqlite3.c      || memcmp((void *)walIndexHdr(pWal), &amp;pWal-&gt;hdr, sizeof(WalIndexHdr))</span>
<span class='curline'><a href='../S/185.html#L50352'>pWal</a>             50352 libdb/sqlite3.c       walUnlockShared(pWal, WAL_READ_LOCK(mxI));</span>
<span class='curline'><a href='../S/185.html#L50355'>pWal</a>             50355 libdb/sqlite3.c       assert( mxReadMark&lt;=pWal-&gt;hdr.mxFrame );</span>
<span class='curline'><a href='../S/185.html#L50356'>pWal</a>             50356 libdb/sqlite3.c       pWal-&gt;readLock = (i16)mxI;</span>
<span class='curline'><a href='../S/185.html#L50376'>pWal</a>             50376 libdb/sqlite3.c SQLITE_PRIVATE int sqlite3WalBeginReadTransaction(Wal *pWal, int *pChanged){</span>
<span class='curline'><a href='../S/185.html#L50381'>pWal</a>             50381 libdb/sqlite3.c     rc = walTryBeginRead(pWal, pChanged, 0, ++cnt);</span>
<span class='curline'><a href='../S/185.html#L50394'>pWal</a>             50394 libdb/sqlite3.c SQLITE_PRIVATE void sqlite3WalEndReadTransaction(Wal *pWal){</span>
<span class='curline'><a href='../S/185.html#L50395'>pWal</a>             50395 libdb/sqlite3.c   sqlite3WalEndWriteTransaction(pWal);</span>
<span class='curline'><a href='../S/185.html#L50396'>pWal</a>             50396 libdb/sqlite3.c   if( pWal-&gt;readLock&gt;=0 ){</span>
<span class='curline'><a href='../S/185.html#L50397'>pWal</a>             50397 libdb/sqlite3.c     walUnlockShared(pWal, WAL_READ_LOCK(pWal-&gt;readLock));</span>
<span class='curline'><a href='../S/185.html#L50398'>pWal</a>             50398 libdb/sqlite3.c     pWal-&gt;readLock = -1;</span>
<span class='curline'><a href='../S/185.html#L50411'>pWal</a>             50411 libdb/sqlite3.c   Wal *pWal,                      /* WAL handle */</span>
<span class='curline'><a href='../S/185.html#L50416'>pWal</a>             50416 libdb/sqlite3.c   u32 iLast = pWal-&gt;hdr.mxFrame;  /* Last page in WAL for this reader */</span>
<span class='curline'><a href='../S/185.html#L50420'>pWal</a>             50420 libdb/sqlite3.c   assert( pWal-&gt;readLock&gt;=0 || pWal-&gt;lockError );</span>
<span class='curline'><a href='../S/185.html#L50428'>pWal</a>             50428 libdb/sqlite3.c   if( iLast==0 || pWal-&gt;readLock==0 ){</span>
<span class='curline'><a href='../S/185.html#L50466'>pWal</a>             50466 libdb/sqlite3.c     rc = walHashGet(pWal, iHash, &amp;aHash, &amp;aPgno, &amp;iZero);</span>
<span class='curline'><a href='../S/185.html#L50491'>pWal</a>             50491 libdb/sqlite3.c       if( walFramePgno(pWal, iTest)==pgno ){</span>
<span class='curline'><a href='../S/185.html#L50510'>pWal</a>             50510 libdb/sqlite3.c   Wal *pWal,                      /* WAL handle */</span>
<span class='curline'><a href='../S/185.html#L50517'>pWal</a>             50517 libdb/sqlite3.c   sz = pWal-&gt;hdr.szPage;</span>
<span class='curline'><a href='../S/185.html#L50523'>pWal</a>             50523 libdb/sqlite3.c   return sqlite3OsRead(pWal-&gt;pWalFd, pOut, (nOut&gt;sz ? sz : nOut), iOffset);</span>
<span class='curline'><a href='../S/185.html#L50529'>pWal</a>             50529 libdb/sqlite3.c SQLITE_PRIVATE Pgno sqlite3WalDbsize(Wal *pWal){</span>
<span class='curline'><a href='../S/185.html#L50530'>pWal</a>             50530 libdb/sqlite3.c   if( pWal &amp;&amp; ALWAYS(pWal-&gt;readLock&gt;=0) ){</span>
<span class='curline'><a href='../S/185.html#L50531'>pWal</a>             50531 libdb/sqlite3.c     return pWal-&gt;hdr.nPage;</span>
<span class='curline'><a href='../S/185.html#L50550'>pWal</a>             50550 libdb/sqlite3.c SQLITE_PRIVATE int sqlite3WalBeginWriteTransaction(Wal *pWal){</span>
<span class='curline'><a href='../S/185.html#L50555'>pWal</a>             50555 libdb/sqlite3.c   assert( pWal-&gt;readLock&gt;=0 );</span>
<span class='curline'><a href='../S/185.html#L50557'>pWal</a>             50557 libdb/sqlite3.c   if( pWal-&gt;readOnly ){</span>
<span class='curline'><a href='../S/185.html#L50564'>pWal</a>             50564 libdb/sqlite3.c   rc = walLockExclusive(pWal, WAL_WRITE_LOCK, 1);</span>
<span class='curline'><a href='../S/185.html#L50568'>pWal</a>             50568 libdb/sqlite3.c   pWal-&gt;writeLock = 1;</span>
<span class='curline'><a href='../S/185.html#L50574'>pWal</a>             50574 libdb/sqlite3.c   if( memcmp(&amp;pWal-&gt;hdr, (void *)walIndexHdr(pWal), sizeof(WalIndexHdr))!=0 ){</span>
<span class='curline'><a href='../S/185.html#L50575'>pWal</a>             50575 libdb/sqlite3.c     walUnlockExclusive(pWal, WAL_WRITE_LOCK, 1);</span>
<span class='curline'><a href='../S/185.html#L50576'>pWal</a>             50576 libdb/sqlite3.c     pWal-&gt;writeLock = 0;</span>
<span class='curline'><a href='../S/185.html#L50587'>pWal</a>             50587 libdb/sqlite3.c SQLITE_PRIVATE int sqlite3WalEndWriteTransaction(Wal *pWal){</span>
<span class='curline'><a href='../S/185.html#L50588'>pWal</a>             50588 libdb/sqlite3.c   if( pWal-&gt;writeLock ){</span>
<span class='curline'><a href='../S/185.html#L50589'>pWal</a>             50589 libdb/sqlite3.c     walUnlockExclusive(pWal, WAL_WRITE_LOCK, 1);</span>
<span class='curline'><a href='../S/185.html#L50590'>pWal</a>             50590 libdb/sqlite3.c     pWal-&gt;writeLock = 0;</span>
<span class='curline'><a href='../S/185.html#L50591'>pWal</a>             50591 libdb/sqlite3.c     pWal-&gt;truncateOnCommit = 0;</span>
<span class='curline'><a href='../S/185.html#L50608'>pWal</a>             50608 libdb/sqlite3.c SQLITE_PRIVATE int sqlite3WalUndo(Wal *pWal, int (*xUndo)(void *, Pgno), void *pUndoCtx){</span>
<span class='curline'><a href='../S/185.html#L50610'>pWal</a>             50610 libdb/sqlite3.c   if( ALWAYS(pWal-&gt;writeLock) ){</span>
<span class='curline'><a href='../S/185.html#L50611'>pWal</a>             50611 libdb/sqlite3.c     Pgno iMax = pWal-&gt;hdr.mxFrame;</span>
<span class='curline'><a href='../S/185.html#L50617'>pWal</a>             50617 libdb/sqlite3.c     memcpy(&amp;pWal-&gt;hdr, (void *)walIndexHdr(pWal), sizeof(WalIndexHdr));</span>
<span class='curline'><a href='../S/185.html#L50619'>pWal</a>             50619 libdb/sqlite3.c     for(iFrame=pWal-&gt;hdr.mxFrame+1; </span>
<span class='curline'><a href='../S/185.html#L50634'>pWal</a>             50634 libdb/sqlite3.c       assert( walFramePgno(pWal, iFrame)!=1 );</span>
<span class='curline'><a href='../S/185.html#L50635'>pWal</a>             50635 libdb/sqlite3.c       rc = xUndo(pUndoCtx, walFramePgno(pWal, iFrame));</span>
<span class='curline'><a href='../S/185.html#L50637'>pWal</a>             50637 libdb/sqlite3.c     if( iMax!=pWal-&gt;hdr.mxFrame ) walCleanupHash(pWal);</span>
<span class='curline'><a href='../S/185.html#L50649'>pWal</a>             50649 libdb/sqlite3.c SQLITE_PRIVATE void sqlite3WalSavepoint(Wal *pWal, u32 *aWalData){</span>
<span class='curline'><a href='../S/185.html#L50650'>pWal</a>             50650 libdb/sqlite3.c   assert( pWal-&gt;writeLock );</span>
<span class='curline'><a href='../S/185.html#L50651'>pWal</a>             50651 libdb/sqlite3.c   aWalData[0] = pWal-&gt;hdr.mxFrame;</span>
<span class='curline'><a href='../S/185.html#L50652'>pWal</a>             50652 libdb/sqlite3.c   aWalData[1] = pWal-&gt;hdr.aFrameCksum[0];</span>
<span class='curline'><a href='../S/185.html#L50653'>pWal</a>             50653 libdb/sqlite3.c   aWalData[2] = pWal-&gt;hdr.aFrameCksum[1];</span>
<span class='curline'><a href='../S/185.html#L50654'>pWal</a>             50654 libdb/sqlite3.c   aWalData[3] = pWal-&gt;nCkpt;</span>
<span class='curline'><a href='../S/185.html#L50663'>pWal</a>             50663 libdb/sqlite3.c SQLITE_PRIVATE int sqlite3WalSavepointUndo(Wal *pWal, u32 *aWalData){</span>
<span class='curline'><a href='../S/185.html#L50666'>pWal</a>             50666 libdb/sqlite3.c   assert( pWal-&gt;writeLock );</span>
<span class='curline'><a href='../S/185.html#L50667'>pWal</a>             50667 libdb/sqlite3.c   assert( aWalData[3]!=pWal-&gt;nCkpt || aWalData[0]&lt;=pWal-&gt;hdr.mxFrame );</span>
<span class='curline'><a href='../S/185.html#L50669'>pWal</a>             50669 libdb/sqlite3.c   if( aWalData[3]!=pWal-&gt;nCkpt ){</span>
<span class='curline'><a href='../S/185.html#L50675'>pWal</a>             50675 libdb/sqlite3.c     aWalData[3] = pWal-&gt;nCkpt;</span>
<span class='curline'><a href='../S/185.html#L50678'>pWal</a>             50678 libdb/sqlite3.c   if( aWalData[0]&lt;pWal-&gt;hdr.mxFrame ){</span>
<span class='curline'><a href='../S/185.html#L50679'>pWal</a>             50679 libdb/sqlite3.c     pWal-&gt;hdr.mxFrame = aWalData[0];</span>
<span class='curline'><a href='../S/185.html#L50680'>pWal</a>             50680 libdb/sqlite3.c     pWal-&gt;hdr.aFrameCksum[0] = aWalData[1];</span>
<span class='curline'><a href='../S/185.html#L50681'>pWal</a>             50681 libdb/sqlite3.c     pWal-&gt;hdr.aFrameCksum[1] = aWalData[2];</span>
<span class='curline'><a href='../S/185.html#L50682'>pWal</a>             50682 libdb/sqlite3.c     walCleanupHash(pWal);</span>
<span class='curline'><a href='../S/185.html#L50701'>pWal</a>             50701 libdb/sqlite3.c static int walRestartLog(Wal *pWal){</span>
<span class='curline'><a href='../S/185.html#L50705'>pWal</a>             50705 libdb/sqlite3.c   if( pWal-&gt;readLock==0 ){</span>
<span class='curline'><a href='../S/185.html#L50706'>pWal</a>             50706 libdb/sqlite3.c     volatile WalCkptInfo *pInfo = walCkptInfo(pWal);</span>
<span class='curline'><a href='../S/185.html#L50707'>pWal</a>             50707 libdb/sqlite3.c     assert( pInfo-&gt;nBackfill==pWal-&gt;hdr.mxFrame );</span>
<span class='curline'><a href='../S/185.html#L50711'>pWal</a>             50711 libdb/sqlite3.c       rc = walLockExclusive(pWal, WAL_READ_LOCK(1), WAL_NREADER-1);</span>
<span class='curline'><a href='../S/185.html#L50724'>pWal</a>             50724 libdb/sqlite3.c         u32 *aSalt = pWal-&gt;hdr.aSalt;       /* Big-endian salt values */</span>
<span class='curline'><a href='../S/185.html#L50726'>pWal</a>             50726 libdb/sqlite3.c         pWal-&gt;nCkpt++;</span>
<span class='curline'><a href='../S/185.html#L50727'>pWal</a>             50727 libdb/sqlite3.c         pWal-&gt;hdr.mxFrame = 0;</span>
<span class='curline'><a href='../S/185.html#L50730'>pWal</a>             50730 libdb/sqlite3.c         walIndexWriteHdr(pWal);</span>
<span class='curline'><a href='../S/185.html#L50735'>pWal</a>             50735 libdb/sqlite3.c         walUnlockExclusive(pWal, WAL_READ_LOCK(1), WAL_NREADER-1);</span>
<span class='curline'><a href='../S/185.html#L50740'>pWal</a>             50740 libdb/sqlite3.c     walUnlockShared(pWal, WAL_READ_LOCK(0));</span>
<span class='curline'><a href='../S/185.html#L50741'>pWal</a>             50741 libdb/sqlite3.c     pWal-&gt;readLock = -1;</span>
<span class='curline'><a href='../S/185.html#L50745'>pWal</a>             50745 libdb/sqlite3.c       rc = walTryBeginRead(pWal, &amp;notUsed, 1, ++cnt);</span>
<span class='curline'><a href='../S/185.html#L50761'>pWal</a>             50761 libdb/sqlite3.c   Wal *pWal;                   /* The complete WAL information */</span>
<span class='curline'><a href='../S/185.html#L50815'>pWal</a>             50815 libdb/sqlite3.c   walEncodeFrame(p-&gt;pWal, pPage-&gt;pgno, nTruncate, pData, aFrame);</span>
<span class='curline'><a href='../S/185.html#L50828'>pWal</a>             50828 libdb/sqlite3.c   Wal *pWal,                      /* Wal handle to write to */</span>
<span class='curline'><a href='../S/185.html#L50845'>pWal</a>             50845 libdb/sqlite3.c   assert( pWal-&gt;writeLock );</span>
<span class='curline'><a href='../S/185.html#L50854'>pWal</a>             50854 libdb/sqlite3.c               pWal, cnt, pWal-&gt;hdr.mxFrame, isCommit ? "Commit" : "Spill"));</span>
<span class='curline'><a href='../S/185.html#L50861'>pWal</a>             50861 libdb/sqlite3.c   if( SQLITE_OK!=(rc = walRestartLog(pWal)) ){</span>
<span class='curline'><a href='../S/185.html#L50869'>pWal</a>             50869 libdb/sqlite3.c   iFrame = pWal-&gt;hdr.mxFrame;</span>
<span class='curline'><a href='../S/185.html#L50877'>pWal</a>             50877 libdb/sqlite3.c     sqlite3Put4byte(&amp;aWalHdr[12], pWal-&gt;nCkpt);</span>
<span class='curline'><a href='../S/185.html#L50878'>pWal</a>             50878 libdb/sqlite3.c     if( pWal-&gt;nCkpt==0 ) sqlite3_randomness(8, pWal-&gt;hdr.aSalt);</span>
<span class='curline'><a href='../S/185.html#L50879'>pWal</a>             50879 libdb/sqlite3.c     memcpy(&amp;aWalHdr[16], pWal-&gt;hdr.aSalt, 8);</span>
<span class='curline'><a href='../S/185.html#L50884'>pWal</a>             50884 libdb/sqlite3.c     pWal-&gt;szPage = szPage;</span>
<span class='curline'><a href='../S/185.html#L50885'>pWal</a>             50885 libdb/sqlite3.c     pWal-&gt;hdr.bigEndCksum = SQLITE_BIGENDIAN;</span>
<span class='curline'><a href='../S/185.html#L50886'>pWal</a>             50886 libdb/sqlite3.c     pWal-&gt;hdr.aFrameCksum[0] = aCksum[0];</span>
<span class='curline'><a href='../S/185.html#L50887'>pWal</a>             50887 libdb/sqlite3.c     pWal-&gt;hdr.aFrameCksum[1] = aCksum[1];</span>
<span class='curline'><a href='../S/185.html#L50888'>pWal</a>             50888 libdb/sqlite3.c     pWal-&gt;truncateOnCommit = 1;</span>
<span class='curline'><a href='../S/185.html#L50890'>pWal</a>             50890 libdb/sqlite3.c     rc = sqlite3OsWrite(pWal-&gt;pWalFd, aWalHdr, sizeof(aWalHdr), 0);</span>
<span class='curline'><a href='../S/185.html#L50891'>pWal</a>             50891 libdb/sqlite3.c     WALTRACE(("WAL%p: wal-header write %s\n", pWal, rc ? "failed" : "ok"));</span>
<span class='curline'><a href='../S/185.html#L50903'>pWal</a>             50903 libdb/sqlite3.c     if( pWal-&gt;syncHeader &amp;&amp; sync_flags ){</span>
<span class='curline'><a href='../S/185.html#L50904'>pWal</a>             50904 libdb/sqlite3.c       rc = sqlite3OsSync(pWal-&gt;pWalFd, sync_flags &amp; SQLITE_SYNC_MASK);</span>
<span class='curline'><a href='../S/185.html#L50908'>pWal</a>             50908 libdb/sqlite3.c   assert( (int)pWal-&gt;szPage==szPage );</span>
<span class='curline'><a href='../S/185.html#L50911'>pWal</a>             50911 libdb/sqlite3.c   w.pWal = pWal;</span>
<span class='curline'><a href='../S/185.html#L50912'>pWal</a>             50912 libdb/sqlite3.c   w.pFd = pWal-&gt;pWalFd;</span>
<span class='curline'><a href='../S/185.html#L50946'>pWal</a>             50946 libdb/sqlite3.c     if( pWal-&gt;padToSectorBoundary ){</span>
<span class='curline'><a href='../S/185.html#L50947'>pWal</a>             50947 libdb/sqlite3.c       int sectorSize = sqlite3SectorSize(pWal-&gt;pWalFd);</span>
<span class='curline'><a href='../S/185.html#L50964'>pWal</a>             50964 libdb/sqlite3.c   if( isCommit &amp;&amp; pWal-&gt;truncateOnCommit &amp;&amp; pWal-&gt;mxWalSize&gt;=0 ){</span>
<span class='curline'><a href='../S/185.html#L50965'>pWal</a>             50965 libdb/sqlite3.c     i64 sz = pWal-&gt;mxWalSize;</span>
<span class='curline'><a href='../S/185.html#L50966'>pWal</a>             50966 libdb/sqlite3.c     if( walFrameOffset(iFrame+nExtra+1, szPage)&gt;pWal-&gt;mxWalSize ){</span>
<span class='curline'><a href='../S/185.html#L50969'>pWal</a>             50969 libdb/sqlite3.c     walLimitSize(pWal, sz);</span>
<span class='curline'><a href='../S/185.html#L50970'>pWal</a>             50970 libdb/sqlite3.c     pWal-&gt;truncateOnCommit = 0;</span>
<span class='curline'><a href='../S/185.html#L50978'>pWal</a>             50978 libdb/sqlite3.c   iFrame = pWal-&gt;hdr.mxFrame;</span>
<span class='curline'><a href='../S/185.html#L50981'>pWal</a>             50981 libdb/sqlite3.c     rc = walIndexAppend(pWal, iFrame, p-&gt;pgno);</span>
<span class='curline'><a href='../S/185.html#L50986'>pWal</a>             50986 libdb/sqlite3.c     rc = walIndexAppend(pWal, iFrame, pLast-&gt;pgno);</span>
<span class='curline'><a href='../S/185.html#L50991'>pWal</a>             50991 libdb/sqlite3.c     pWal-&gt;hdr.szPage = (u16)((szPage&amp;0xff00) | (szPage&gt;&gt;16));</span>
<span class='curline'><a href='../S/185.html#L50994'>pWal</a>             50994 libdb/sqlite3.c     pWal-&gt;hdr.mxFrame = iFrame;</span>
<span class='curline'><a href='../S/185.html#L50996'>pWal</a>             50996 libdb/sqlite3.c       pWal-&gt;hdr.iChange++;</span>
<span class='curline'><a href='../S/185.html#L50997'>pWal</a>             50997 libdb/sqlite3.c       pWal-&gt;hdr.nPage = nTruncate;</span>
<span class='curline'><a href='../S/185.html#L51001'>pWal</a>             51001 libdb/sqlite3.c       walIndexWriteHdr(pWal);</span>
<span class='curline'><a href='../S/185.html#L51002'>pWal</a>             51002 libdb/sqlite3.c       pWal-&gt;iCallback = iFrame;</span>
<span class='curline'><a href='../S/185.html#L51006'>pWal</a>             51006 libdb/sqlite3.c   WALTRACE(("WAL%p: frame write %s\n", pWal, rc ? "failed" : "ok"));</span>
<span class='curline'><a href='../S/185.html#L51021'>pWal</a>             51021 libdb/sqlite3.c   Wal *pWal,                      /* Wal connection */</span>
<span class='curline'><a href='../S/185.html#L51035'>pWal</a>             51035 libdb/sqlite3.c   assert( pWal-&gt;ckptLock==0 );</span>
<span class='curline'><a href='../S/185.html#L51036'>pWal</a>             51036 libdb/sqlite3.c   assert( pWal-&gt;writeLock==0 );</span>
<span class='curline'><a href='../S/185.html#L51038'>pWal</a>             51038 libdb/sqlite3.c   if( pWal-&gt;readOnly ) return SQLITE_READONLY;</span>
<span class='curline'><a href='../S/185.html#L51039'>pWal</a>             51039 libdb/sqlite3.c   WALTRACE(("WAL%p: checkpoint begins\n", pWal));</span>
<span class='curline'><a href='../S/185.html#L51040'>pWal</a>             51040 libdb/sqlite3.c   rc = walLockExclusive(pWal, WAL_CKPT_LOCK, 1);</span>
<span class='curline'><a href='../S/185.html#L51047'>pWal</a>             51047 libdb/sqlite3.c   pWal-&gt;ckptLock = 1;</span>
<span class='curline'><a href='../S/185.html#L51059'>pWal</a>             51059 libdb/sqlite3.c     rc = walBusyLock(pWal, xBusy, pBusyArg, WAL_WRITE_LOCK, 1);</span>
<span class='curline'><a href='../S/185.html#L51061'>pWal</a>             51061 libdb/sqlite3.c       pWal-&gt;writeLock = 1;</span>
<span class='curline'><a href='../S/185.html#L51070'>pWal</a>             51070 libdb/sqlite3.c     rc = walIndexReadHdr(pWal, &amp;isChanged);</span>
<span class='curline'><a href='../S/185.html#L51071'>pWal</a>             51071 libdb/sqlite3.c     if( isChanged &amp;&amp; pWal-&gt;pDbFd-&gt;pMethods-&gt;iVersion&gt;=3 ){</span>
<span class='curline'><a href='../S/185.html#L51072'>pWal</a>             51072 libdb/sqlite3.c       sqlite3OsUnfetch(pWal-&gt;pDbFd, 0, 0);</span>
<span class='curline'><a href='../S/185.html#L51078'>pWal</a>             51078 libdb/sqlite3.c     if( pWal-&gt;hdr.mxFrame &amp;&amp; walPagesize(pWal)!=nBuf ){</span>
<span class='curline'><a href='../S/185.html#L51081'>pWal</a>             51081 libdb/sqlite3.c       rc = walCheckpoint(pWal, eMode2, xBusy, pBusyArg, sync_flags, zBuf);</span>
<span class='curline'><a href='../S/185.html#L51086'>pWal</a>             51086 libdb/sqlite3.c       if( pnLog ) *pnLog = (int)pWal-&gt;hdr.mxFrame;</span>
<span class='curline'><a href='../S/185.html#L51087'>pWal</a>             51087 libdb/sqlite3.c       if( pnCkpt ) *pnCkpt = (int)(walCkptInfo(pWal)-&gt;nBackfill);</span>
<span class='curline'><a href='../S/185.html#L51098'>pWal</a>             51098 libdb/sqlite3.c     memset(&amp;pWal-&gt;hdr, 0, sizeof(WalIndexHdr));</span>
<span class='curline'><a href='../S/185.html#L51102'>pWal</a>             51102 libdb/sqlite3.c   sqlite3WalEndWriteTransaction(pWal);</span>
<span class='curline'><a href='../S/185.html#L51103'>pWal</a>             51103 libdb/sqlite3.c   walUnlockExclusive(pWal, WAL_CKPT_LOCK, 1);</span>
<span class='curline'><a href='../S/185.html#L51104'>pWal</a>             51104 libdb/sqlite3.c   pWal-&gt;ckptLock = 0;</span>
<span class='curline'><a href='../S/185.html#L51105'>pWal</a>             51105 libdb/sqlite3.c   WALTRACE(("WAL%p: checkpoint %s\n", pWal, rc ? "failed" : "ok"));</span>
<span class='curline'><a href='../S/185.html#L51114'>pWal</a>             51114 libdb/sqlite3.c SQLITE_PRIVATE int sqlite3WalCallback(Wal *pWal){</span>
<span class='curline'><a href='../S/185.html#L51116'>pWal</a>             51116 libdb/sqlite3.c   if( pWal ){</span>
<span class='curline'><a href='../S/185.html#L51117'>pWal</a>             51117 libdb/sqlite3.c     ret = pWal-&gt;iCallback;</span>
<span class='curline'><a href='../S/185.html#L51118'>pWal</a>             51118 libdb/sqlite3.c     pWal-&gt;iCallback = 0;</span>
<span class='curline'><a href='../S/185.html#L51147'>pWal</a>             51147 libdb/sqlite3.c SQLITE_PRIVATE int sqlite3WalExclusiveMode(Wal *pWal, int op){</span>
<span class='curline'><a href='../S/185.html#L51149'>pWal</a>             51149 libdb/sqlite3.c   assert( pWal-&gt;writeLock==0 );</span>
<span class='curline'><a href='../S/185.html#L51150'>pWal</a>             51150 libdb/sqlite3.c   assert( pWal-&gt;exclusiveMode!=WAL_HEAPMEMORY_MODE || op==-1 );</span>
<span class='curline'><a href='../S/185.html#L51158'>pWal</a>             51158 libdb/sqlite3.c   assert( pWal-&gt;readLock&gt;=0 || pWal-&gt;lockError );</span>
<span class='curline'><a href='../S/185.html#L51159'>pWal</a>             51159 libdb/sqlite3.c   assert( pWal-&gt;readLock&gt;=0 || (op&lt;=0 &amp;&amp; pWal-&gt;exclusiveMode==0) );</span>
<span class='curline'><a href='../S/185.html#L51162'>pWal</a>             51162 libdb/sqlite3.c     if( pWal-&gt;exclusiveMode ){</span>
<span class='curline'><a href='../S/185.html#L51163'>pWal</a>             51163 libdb/sqlite3.c       pWal-&gt;exclusiveMode = 0;</span>
<span class='curline'><a href='../S/185.html#L51164'>pWal</a>             51164 libdb/sqlite3.c       if( walLockShared(pWal, WAL_READ_LOCK(pWal-&gt;readLock))!=SQLITE_OK ){</span>
<span class='curline'><a href='../S/185.html#L51165'>pWal</a>             51165 libdb/sqlite3.c         pWal-&gt;exclusiveMode = 1;</span>
<span class='curline'><a href='../S/185.html#L51167'>pWal</a>             51167 libdb/sqlite3.c       rc = pWal-&gt;exclusiveMode==0;</span>
<span class='curline'><a href='../S/185.html#L51173'>pWal</a>             51173 libdb/sqlite3.c     assert( pWal-&gt;exclusiveMode==0 );</span>
<span class='curline'><a href='../S/185.html#L51174'>pWal</a>             51174 libdb/sqlite3.c     assert( pWal-&gt;readLock&gt;=0 );</span>
<span class='curline'><a href='../S/185.html#L51175'>pWal</a>             51175 libdb/sqlite3.c     walUnlockShared(pWal, WAL_READ_LOCK(pWal-&gt;readLock));</span>
<span class='curline'><a href='../S/185.html#L51176'>pWal</a>             51176 libdb/sqlite3.c     pWal-&gt;exclusiveMode = 1;</span>
<span class='curline'><a href='../S/185.html#L51179'>pWal</a>             51179 libdb/sqlite3.c     rc = pWal-&gt;exclusiveMode==0;</span>
<span class='curline'><a href='../S/185.html#L51189'>pWal</a>             51189 libdb/sqlite3.c SQLITE_PRIVATE int sqlite3WalHeapMemory(Wal *pWal){</span>
<span class='curline'><a href='../S/185.html#L51190'>pWal</a>             51190 libdb/sqlite3.c   return (pWal &amp;&amp; pWal-&gt;exclusiveMode==WAL_HEAPMEMORY_MODE );</span>
<span class='curline'><a href='../S/185.html#L51199'>pWal</a>             51199 libdb/sqlite3.c SQLITE_PRIVATE int sqlite3WalFramesize(Wal *pWal){</span>
<span class='curline'><a href='../S/185.html#L51200'>pWal</a>             51200 libdb/sqlite3.c   assert( pWal==0 || pWal-&gt;readLock&gt;=0 );</span>
<span class='curline'><a href='../S/185.html#L51201'>pWal</a>             51201 libdb/sqlite3.c   return (pWal ? pWal-&gt;szPage : 0);</span>
</pre>
</body>
</html>
